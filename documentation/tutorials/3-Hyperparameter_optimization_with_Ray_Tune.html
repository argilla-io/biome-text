<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hyperparameter optimization with Ray Tune | biome.text</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="shortcut icon" href="/biome-text/favicon.ico">
    <meta name="description" content="biome.text practical NLP open source library.">
    <meta property="og:image" content="https://www.recogn.ai/images/biome_og.png">
    
    <link rel="preload" href="/biome-text/assets/css/0.styles.9a136751.css" as="style"><link rel="preload" href="/biome-text/assets/js/app.6e62ef31.js" as="script"><link rel="preload" href="/biome-text/assets/js/4.2d46529d.js" as="script"><link rel="preload" href="/biome-text/assets/js/3.73bd0a1f.js" as="script"><link rel="preload" href="/biome-text/assets/js/5.5615e4e8.js" as="script"><link rel="prefetch" href="/biome-text/assets/js/10.423e3e15.js"><link rel="prefetch" href="/biome-text/assets/js/11.d82bccc8.js"><link rel="prefetch" href="/biome-text/assets/js/12.2f62e511.js"><link rel="prefetch" href="/biome-text/assets/js/13.062db869.js"><link rel="prefetch" href="/biome-text/assets/js/14.f40b69a1.js"><link rel="prefetch" href="/biome-text/assets/js/15.53e49813.js"><link rel="prefetch" href="/biome-text/assets/js/16.829a0d06.js"><link rel="prefetch" href="/biome-text/assets/js/17.fa7a31be.js"><link rel="prefetch" href="/biome-text/assets/js/18.8dc1187c.js"><link rel="prefetch" href="/biome-text/assets/js/19.30f3f71c.js"><link rel="prefetch" href="/biome-text/assets/js/20.24ae8cd0.js"><link rel="prefetch" href="/biome-text/assets/js/21.422003f0.js"><link rel="prefetch" href="/biome-text/assets/js/22.d1745059.js"><link rel="prefetch" href="/biome-text/assets/js/23.6f421605.js"><link rel="prefetch" href="/biome-text/assets/js/24.9fe3b3a3.js"><link rel="prefetch" href="/biome-text/assets/js/25.0d992e9d.js"><link rel="prefetch" href="/biome-text/assets/js/26.212f011b.js"><link rel="prefetch" href="/biome-text/assets/js/27.23f0bf9e.js"><link rel="prefetch" href="/biome-text/assets/js/28.26850a8e.js"><link rel="prefetch" href="/biome-text/assets/js/29.0fccdd07.js"><link rel="prefetch" href="/biome-text/assets/js/30.a9ad34f3.js"><link rel="prefetch" href="/biome-text/assets/js/31.d8a99565.js"><link rel="prefetch" href="/biome-text/assets/js/32.c60efde5.js"><link rel="prefetch" href="/biome-text/assets/js/33.44b9597c.js"><link rel="prefetch" href="/biome-text/assets/js/34.6efb8a1b.js"><link rel="prefetch" href="/biome-text/assets/js/35.0e4cb618.js"><link rel="prefetch" href="/biome-text/assets/js/36.f5f3d7e8.js"><link rel="prefetch" href="/biome-text/assets/js/37.864d5e64.js"><link rel="prefetch" href="/biome-text/assets/js/38.f8b0915c.js"><link rel="prefetch" href="/biome-text/assets/js/39.25bce7d1.js"><link rel="prefetch" href="/biome-text/assets/js/40.9061c4da.js"><link rel="prefetch" href="/biome-text/assets/js/41.a97407a9.js"><link rel="prefetch" href="/biome-text/assets/js/42.b4fc93eb.js"><link rel="prefetch" href="/biome-text/assets/js/43.b86f8e6a.js"><link rel="prefetch" href="/biome-text/assets/js/44.78b4412d.js"><link rel="prefetch" href="/biome-text/assets/js/45.5d32843d.js"><link rel="prefetch" href="/biome-text/assets/js/46.6f120c2a.js"><link rel="prefetch" href="/biome-text/assets/js/47.87cc273c.js"><link rel="prefetch" href="/biome-text/assets/js/48.929da560.js"><link rel="prefetch" href="/biome-text/assets/js/49.4bfcfd6c.js"><link rel="prefetch" href="/biome-text/assets/js/50.04843b8f.js"><link rel="prefetch" href="/biome-text/assets/js/51.b1dd354a.js"><link rel="prefetch" href="/biome-text/assets/js/52.563cff3c.js"><link rel="prefetch" href="/biome-text/assets/js/53.bacf1a4f.js"><link rel="prefetch" href="/biome-text/assets/js/54.ce9ff605.js"><link rel="prefetch" href="/biome-text/assets/js/55.383eed1e.js"><link rel="prefetch" href="/biome-text/assets/js/56.997596a9.js"><link rel="prefetch" href="/biome-text/assets/js/57.73f91806.js"><link rel="prefetch" href="/biome-text/assets/js/58.c3dfd742.js"><link rel="prefetch" href="/biome-text/assets/js/59.f9d08fb1.js"><link rel="prefetch" href="/biome-text/assets/js/6.b32bfc34.js"><link rel="prefetch" href="/biome-text/assets/js/60.5043f7ff.js"><link rel="prefetch" href="/biome-text/assets/js/61.5f0045a5.js"><link rel="prefetch" href="/biome-text/assets/js/62.3f9cf842.js"><link rel="prefetch" href="/biome-text/assets/js/63.65c19267.js"><link rel="prefetch" href="/biome-text/assets/js/64.cdf05997.js"><link rel="prefetch" href="/biome-text/assets/js/7.5160a3bb.js"><link rel="prefetch" href="/biome-text/assets/js/8.943094cf.js"><link rel="prefetch" href="/biome-text/assets/js/9.f29c9062.js"><link rel="prefetch" href="/biome-text/assets/js/vendors~docsearch.62a8c583.js">
    <link rel="stylesheet" href="/biome-text/assets/css/0.styles.9a136751.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-44f1b6a5><header class="navbar" data-v-44f1b6a5><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/biome-text/" class="home-link router-link-active"><!----> <span class="site-name">biome<span>.text</span></span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/biome-text/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/biome-text/documentation/" class="nav-link router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="https://github.com/recognai/biome-text" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span class="external__icon"><vp-icon color="#4A4A4A" name="blank" size="12px"></vp-icon></span></a></div><div class="nav-item"><a href="https://recogn.ai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Recognai
  <span class="external__icon"><vp-icon color="#4A4A4A" name="blank" size="12px"></vp-icon></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-44f1b6a5></div> <aside class="sidebar" data-v-44f1b6a5><div class="sidebar__link"><a href="/biome-text/"><img src="/biome-text/assets/img/biome.svg" class="sidebar__img"></a></div> <nav class="nav-links"><div class="nav-item"><a href="/biome-text/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/biome-text/documentation/" class="nav-link router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="https://github.com/recognai/biome-text" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span class="external__icon"><vp-icon color="#4A4A4A" name="blank" size="12px"></vp-icon></span></a></div><div class="nav-item"><a href="https://recogn.ai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Recognai
  <span class="external__icon"><vp-icon color="#4A4A4A" name="blank" size="12px"></vp-icon></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Get started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/biome-text/documentation/" aria-current="page" class="sidebar-link">Installation</a></li><li><a href="/biome-text/documentation/basics.html" class="sidebar-link">The basics</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Tutorials</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/biome-text/documentation/tutorials/1-Training_a_text_classifier.html" class="sidebar-link">Training a short text classifier of German business names</a></li><li><a href="/biome-text/documentation/tutorials/2-Training_a_sequence_tagger_for_Slot_Filling.html" class="sidebar-link">Training a sequence tagger for Slot Filling</a></li><li><a href="/biome-text/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.html" aria-current="page" class="active sidebar-link">Hyperparameter optimization with Ray Tune</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/biome-text/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.html#imports" class="sidebar-link">Imports</a></li><li class="sidebar-sub-header"><a href="/biome-text/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.html#creating-the-datasets" class="sidebar-link">Creating the datasets</a></li><li class="sidebar-sub-header"><a href="/biome-text/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.html#defining-the-pipeline-and-the-search-space" class="sidebar-link">Defining the pipeline and the search space</a></li><li class="sidebar-sub-header"><a href="/biome-text/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.html#starting-the-random-search" class="sidebar-link">Starting the random search</a></li><li class="sidebar-sub-header"><a href="/biome-text/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.html#checking-the-results" class="sidebar-link">Checking the results</a></li><li class="sidebar-sub-header"><a href="/biome-text/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.html#appendix-custom-hpo-with-ray-tune" class="sidebar-link">Appendix: Custom HPO with ray tune</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>User Guides</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/biome-text/documentation/user-guides/1-nlp-tasks.html" class="sidebar-link">NLP Tasks</a></li><li><a href="/biome-text/documentation/user-guides/2-configuration.html" class="sidebar-link">Configuration</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Community</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/biome-text/documentation/community/contributing.html" class="sidebar-link">Contributing</a></li><li><a href="/biome-text/documentation/community/get_help.html" class="sidebar-link">Getting help</a></li></ul></section></li></ul> </aside> <main class="page" data-v-44f1b6a5> <div class="theme-default-content content__default"><h1 id="hyperparameter-optimization-with-ray-tune"><a href="#hyperparameter-optimization-with-ray-tune" class="header-anchor">#</a> Hyperparameter optimization with Ray Tune</h1> <p><a target="_blank" href="https://www.recogn.ai/biome-text/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.html"><img src="https://www.recogn.ai/biome-text/assets/img/biome-isotype.svg" width="24" class="icon"></a> <a href="https://www.recogn.ai/biome-text/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.html" target="_blank" rel="noopener noreferrer">View on recogn.ai<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a target="_blank" href="https://colab.research.google.com/github/recognai/biome-text/blob/master/docs/docs/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.ipynb"><img src="https://www.tensorflow.org/images/colab_logo_32px.png" width="24" class="icon"></a> <a href="https://colab.research.google.com/github/recognai/biome-text/blob/master/docs/docs/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.ipynb" target="_blank" rel="noopener noreferrer">Run in Google Colab<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a target="_blank" href="https://github.com/recognai/biome-text/blob/master/docs/docs/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.ipynb"><img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" width="24" class="icon"></a> <a href="https://github.com/recognai/biome-text/blob/master/docs/docs/documentation/tutorials/3-Hyperparameter_optimization_with_Ray_Tune.ipynb" target="_blank" rel="noopener noreferrer">View source on GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Here we will optimize the hyperparameters of the short-text classifier from <a href="https://www.recogn.ai/biome-text/documentation/tutorials/1-Training_a_text_classifier.html" target="_blank" rel="noopener noreferrer">this tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, hence we recommend to have a look at it first before going through this tutorial.
For the Hyper-Parameter Optimization (HPO) we rely on the awesome <a href="https://docs.ray.io/en/latest/tune.html#tune-index" target="_blank" rel="noopener noreferrer">Ray Tune library<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>For a short introduction to HPO with Ray Tune you can have a look at this nice <a href="https://www.youtube.com/watch?v=VX7HvEoMrsA" target="_blank" rel="noopener noreferrer">talk<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> by Richard Liaw.
We will follow his terminology and use the term <em>trial</em> to refer to a training run of one set of hyperparameters.</p> <p>When running this tutorial in Google Colab, make sure to install <em>biome.text</em> and <em>ray tune</em> first:</p> <div class="language-python extra-class"><pre class="language-python"><code>!pip install <span class="token operator">-</span>U git<span class="token operator">+</span>https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>recognai<span class="token operator">/</span>biome<span class="token operator">-</span>text<span class="token punctuation">.</span>git
</code></pre></div><p>Ignore warnings and don't forget to restart your runtime afterwards (<em>Runtime -&gt; Restart runtime</em>).</p> <p>If you want to log your runs with <a href="https://wandb.ai" target="_blank" rel="noopener noreferrer">WandB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, don't forget to install its client and log in.</p> <div class="language-python extra-class"><pre class="language-python"><code>!pip install wandb
!wandb login
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Note</p> <p>In this tutorial we will use a GPU by default.
So when running this tutorial in Google Colab, make sure that you request one (<em>Edit -&gt; Notebook settings</em>).</p></div> <h2 id="imports"><a href="#imports" class="header-anchor">#</a> Imports</h2> <p>First let's import all the stuff we need for this tutorial:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">from</span> biome<span class="token punctuation">.</span>text <span class="token keyword">import</span> Pipeline<span class="token punctuation">,</span> Dataset
<span class="token keyword">from</span> biome<span class="token punctuation">.</span>text<span class="token punctuation">.</span>configuration <span class="token keyword">import</span> VocabularyConfiguration<span class="token punctuation">,</span> WordFeatures<span class="token punctuation">,</span> TrainerConfiguration
<span class="token keyword">from</span> biome<span class="token punctuation">.</span>text<span class="token punctuation">.</span>loggers <span class="token keyword">import</span> BaseTrainLogger
<span class="token keyword">from</span> biome<span class="token punctuation">.</span>text<span class="token punctuation">.</span>hpo <span class="token keyword">import</span> TuneExperiment
<span class="token keyword">from</span> ray <span class="token keyword">import</span> tune
</code></pre></div><h2 id="creating-the-datasets"><a href="#creating-the-datasets" class="header-anchor">#</a> Creating the datasets</h2> <p>As a first step we will download the training and validation data to our local machine, and create our datasets.</p> <div class="language-python extra-class"><pre class="language-python"><code>!curl <span class="token operator">-</span>O https<span class="token punctuation">:</span><span class="token operator">//</span>biome<span class="token operator">-</span>tutorials<span class="token operator">-</span>data<span class="token punctuation">.</span>s3<span class="token operator">-</span>eu<span class="token operator">-</span>west<span class="token operator">-</span><span class="token number">1.</span>amazonaws<span class="token punctuation">.</span>com<span class="token operator">/</span>text_classifier<span class="token operator">/</span>business<span class="token punctuation">.</span>cat<span class="token punctuation">.</span>train<span class="token punctuation">.</span>csv
!curl <span class="token operator">-</span>O https<span class="token punctuation">:</span><span class="token operator">//</span>biome<span class="token operator">-</span>tutorials<span class="token operator">-</span>data<span class="token punctuation">.</span>s3<span class="token operator">-</span>eu<span class="token operator">-</span>west<span class="token operator">-</span><span class="token number">1.</span>amazonaws<span class="token punctuation">.</span>com<span class="token operator">/</span>text_classifier<span class="token operator">/</span>business<span class="token punctuation">.</span>cat<span class="token punctuation">.</span>valid<span class="token punctuation">.</span>csv
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>train_ds <span class="token operator">=</span> Dataset<span class="token punctuation">.</span>from_csv<span class="token punctuation">(</span><span class="token string">&quot;business.cat.train.csv&quot;</span><span class="token punctuation">)</span>
valid_ds <span class="token operator">=</span> Dataset<span class="token punctuation">.</span>from_csv<span class="token punctuation">(</span><span class="token string">&quot;business.cat.valid.csv&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="defining-the-pipeline-and-the-search-space"><a href="#defining-the-pipeline-and-the-search-space" class="header-anchor">#</a> Defining the pipeline and the search space</h2> <p>As mentioned in the introduction we will use the same pipeline configuration as used in the <a href="https://www.recogn.ai/biome-text/documentation/tutorials/1-Training_a_text_classifier.html" target="_blank" rel="noopener noreferrer">base tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>).</p> <p>To perform a random hyperparameter search (as well as a grid search) we simply have to replace the parameters we want to optimize with methods from the <a href="https://docs.ray.io/en/latest/tune/api_docs/search_space.html#random-distributions-api" target="_blank" rel="noopener noreferrer">Random Distributions API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or the <a href="https://docs.ray.io/en/latest/tune/api_docs/search_space.html#grid-search-api" target="_blank" rel="noopener noreferrer">Grid Search API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in our configuration dictionaries.
For a complete description of both APIs and how they interplay with each other, see the corresponding section in the <a href="https://docs.ray.io/en/latest/tune/api_docs/search_space.html" target="_blank" rel="noopener noreferrer">Ray Tune docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>In our case we will tune 9 parameters:</p> <ul><li>the output dimensions of our <code>word</code> and <code>char</code> features</li> <li>the dropout of our <code>char</code> feature</li> <li>the architecture of our pooler (<em>GRU</em> versus <em>LSTM</em>)</li> <li>number of layers and hidden size of our pooler, as well as if it should be bidirectional</li> <li>hidden dimension of our feed forward network</li> <li>and the learning rate</li></ul> <p>For most of the parameters we will provide discrete values from which Tune will sample randomly, while for the dropout and learning rate we will provide a continuous linear and logarithmic range, respectively.
Since we want to directly compare the outcome of the optimization with the base configuration of the <a href="https://www.recogn.ai/biome-text/documentation/tutorials/1-Training_a_text_classifier.html" target="_blank" rel="noopener noreferrer">underlying tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, we will fix the number of epochs to 3.</p> <p>Not all of the parameters above are worth tuning, but we want to stress the flexibility that <em>Ray Tune</em> and <em>biome.text</em> offers you.</p> <div class="custom-block tip"><p class="custom-block-title">Tip</p> <p>Keep in mind that the learning rate &quot;<em>is often the single most important hyper-parameter and one should always make sure that it has been tuned (up to approximately a factor of 2). ... If there is only time to optimize one hyper-parameter and one uses stochastic gradient descent, then this is the hyper-parameter that is worth tuning.</em>&quot; (<a href="https://arxiv.org/abs/1206.5533" target="_blank" rel="noopener noreferrer">Yoshua Bengio<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>).</p></div> <p>In the following configuration dictionaries we replaced the relevant parameters with tune's search spaces.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># defining the search spaces in our pipeline config</span>
pipeline_config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;german_business_names&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;tokenizer&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;text_cleaning&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;rules&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;strip_spaces&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;features&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;word&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;embedding_dim&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;lowercase_tokens&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;char&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;embedding_dim&quot;</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
            <span class="token string">&quot;lowercase_characters&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">&quot;encoder&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;gru&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;num_layers&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string">&quot;hidden_size&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;bidirectional&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">&quot;dropout&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;head&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;TextClassification&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;labels&quot;</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>train_ds<span class="token punctuation">[</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;pooler&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;gru&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lstm&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;num_layers&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;hidden_size&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;bidirectional&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;feedforward&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;num_layers&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">&quot;hidden_dims&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;activations&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;relu&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;dropout&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>       
<span class="token punctuation">}</span>

<span class="token comment"># defining the search spaces in our trainer config</span>
trainer_config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;optimizer&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;adam&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;lr&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>loguniform<span class="token punctuation">(</span><span class="token number">0.001</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;num_epochs&quot;</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Note</p> <p>By default we will use a GPU if available.
If you do not want to use your GPU, just specify <code>&quot;cuda_device&quot;: -1</code> in your <code>trainer_config</code> above.</p></div> <h2 id="starting-the-random-search"><a href="#starting-the-random-search" class="header-anchor">#</a> Starting the random search</h2> <p>Before starting our random hyperparameter search we first have to create a <code>TuneExperiment</code> instance with our configurations dicts and our datasets.
We also set a name that will mainly be used as project and experiment name for the integrated WandB and MLFlow logger, respectively.</p> <p>Furthermore, we can pass on all the parameters available for the underlying <a href="https://docs.ray.io/en/master/tune/api_docs/execution.html#tune-experiment" target="_blank" rel="noopener noreferrer"><code>tune.Experiment</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> class:</p> <ul><li><p>The number of trials our search will go through depends on the <code>num_samples</code> parameter.
In our case, a random search, it equals the number of trials, whereas in the case of a grid search the total number of trials is <code>num_samples</code> times the grid configurations (see the <a href="https://docs.ray.io/en/latest/tune/api_docs/search_space.html#overview" target="_blank" rel="noopener noreferrer">Tune docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for illustrative examples).</p></li> <li><p>The <code>local_dir</code> parameter defines the output directory of the HPO results and will also contain the training results of each trial (that is the model weights and metrics).</p></li> <li><p>The number of parallel running trials depends on your <code>resources_per_trial</code> configuration and your local resources.
The default value is <code>{&quot;cpu&quot;: 1, &quot;gpu&quot;: 0}</code> and results, for example, in 8 parallel running trials on a machine with 8 CPUs.
You can also use fractional values. To share a GPU between 2 trials, for example, pass on <code>{&quot;gpu&quot;: 0.5}</code>.</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>Keep in mind: to run your HPO on GPUs, you have to specify them in the <code>resources_per_trial</code> parameter when calling <code>tune.run()</code>.
If you do not want to use a GPU, just set the value to 0 <code>{&quot;cpu&quot;: 1, &quot;gpu&quot;: 0}</code>.</p></div> <div class="language-python extra-class"><pre class="language-python"><code>my_random_search <span class="token operator">=</span> TuneExperiment<span class="token punctuation">(</span>
    pipeline_config<span class="token operator">=</span>pipeline_config<span class="token punctuation">,</span>
    trainer_config<span class="token operator">=</span>trainer_config<span class="token punctuation">,</span>
    train_dataset<span class="token operator">=</span>train_ds<span class="token punctuation">,</span>
    valid_dataset<span class="token operator">=</span>valid_ds<span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">&quot;My first random search&quot;</span><span class="token punctuation">,</span>
    <span class="token comment"># `tune.Experiment` kwargs:</span>
    num_samples<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
    local_dir<span class="token operator">=</span><span class="token string">&quot;tune_runs&quot;</span><span class="token punctuation">,</span>
    resources_per_trial<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;cpu&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;gpu&quot;</span><span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre></div><p>With our <code>TuneExperiment</code> object at hand, we simply have to pass it on to the <a href="https://docs.ray.io/en/master/tune/api_docs/execution.html#tune-run" target="_blank" rel="noopener noreferrer"><code>tune.run</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function to start our random search.</p> <p>In this tutorial we will perform a random search together with the <a href="https://blog.ml.cmu.edu/2018/12/12/massively-parallel-hyperparameter-optimization/" target="_blank" rel="noopener noreferrer">Asynchronous Successive Halving Algorithm (ASHA)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to schedule our trials.
The Ray Tune developers advocate this <code>scheduler</code> as a good starting point for its aggressive termination of low-performing trials.
You can look up the available configurations in the <a href="https://docs.ray.io/en/latest/tune/api_docs/schedulers.html#asha-tune-schedulers-ashascheduler" target="_blank" rel="noopener noreferrer">ASHAScheduler docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, here we will just use the default parameters.</p> <p>We also have to specify on what <code>metric</code> to optimize and its <code>mode</code> (should the metric be <em>minimized</em> (<code>min</code>) or <em>maximized</em> (<code>max</code>) ).</p> <p>The <code>progress_reporter</code> is a nice feature to keep track of the progress inside a Jupyter Notebook, for example.</p> <div class="language-python extra-class"><pre class="language-python"><code>analysis <span class="token operator">=</span> tune<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
    my_random_search<span class="token punctuation">,</span>
    scheduler<span class="token operator">=</span>tune<span class="token punctuation">.</span>schedulers<span class="token punctuation">.</span>ASHAScheduler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    metric<span class="token operator">=</span><span class="token string">&quot;validation_loss&quot;</span><span class="token punctuation">,</span> 
    mode<span class="token operator">=</span><span class="token string">&quot;min&quot;</span><span class="token punctuation">,</span>
    progress_reporter<span class="token operator">=</span>tune<span class="token punctuation">.</span>JupyterNotebookReporter<span class="token punctuation">(</span>overwrite<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="following-the-progress-with-tensorboard-optional"><a href="#following-the-progress-with-tensorboard-optional" class="header-anchor">#</a> Following the progress with tensorboard (optional)</h3> <p>Ray Tune automatically logs its results with <a href="https://www.tensorflow.org/tensorboard/" target="_blank" rel="noopener noreferrer">TensorBoard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
We can take advantage of this and launch a TensorBoard instance before starting the hyperparameter search to follow its progress.
The <code>RayTuneTrainable</code> class will also log the metrics to MLFlow and WandB, if you prefer those platforms.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">%</span>load_ext tensorboard
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">%</span>tensorboard <span class="token operator">-</span><span class="token operator">-</span>logdir <span class="token punctuation">.</span><span class="token operator">/</span>runs<span class="token operator">/</span>tune
</code></pre></div><p><img src="/biome-text/assets/img/hpo_tensorboard.99b04f5c.png" alt="Screenshot of TensorBoard with Ray Tune"> <em>Screenshot of TensorBoard</em></p> <h2 id="checking-the-results"><a href="#checking-the-results" class="header-anchor">#</a> Checking the results</h2> <p>The <em>analysis</em> object returned by <code>tune.run</code> can be accessed through a <em>pandas DataFrame</em>.</p> <div class="language-python extra-class"><pre class="language-python"><code>analysis<span class="token punctuation">.</span>dataframe<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token string">&quot;validation_loss&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/biome-text/assets/img/analysis_df.33ad9b08.png" alt="Screenshot of the analysis dataframe"> <em>Screenshot of the analysis dataframe</em></p> <p>Event though with 50 trials we visit just a small space of our possible configurations, we should have achieved an accuracy of ~0.94, an increase of roughly 3 points compared to the original configuration of the <a href="https://www.recogn.ai/biome-text/documentation/tutorials/1-Training_a_text_classifier.html" target="_blank" rel="noopener noreferrer">base tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>In a real-life example, though, you probably should increase the number of epochs, since the validation loss in general seems to be decreasing further.</p> <p>A next step could be to fix some of the tuned parameters to the preferred value, and tune other parameters further or limit their value space.</p> <div class="custom-block tip"><p class="custom-block-title">Tip</p> <p>To obtain insights about the importance and tendencies of each hyperparameter for the model, we recommend using TensorBoard's <em>HPARAM</em> section and follow Richard Liaw's suggestions at the end of his <a href="https://www.youtube.com/watch?v=VX7HvEoMrsA" target="_blank" rel="noopener noreferrer">talk<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <h3 id="evaluating-the-best-performing-model"><a href="#evaluating-the-best-performing-model" class="header-anchor">#</a> Evaluating the best performing model</h3> <p>The <em>analysis</em> object also provides some convenient methods to obtain the best performing configuration, as well as the <code>logdir</code> where the results of the trial are saved.</p> <div class="language-python extra-class"><pre class="language-python"><code>analysis<span class="token punctuation">.</span>get_best_config<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>best_config <span class="token operator">=</span> analysis<span class="token punctuation">.</span>get_best_config<span class="token punctuation">(</span><span class="token punctuation">)</span>
best_logdir <span class="token operator">=</span> analysis<span class="token punctuation">.</span>get_best_logdir<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>We can use the <code>best_logdir</code> to create a pipeline with the best performing model and start making predictions.</p> <div class="language-python extra-class"><pre class="language-python"><code>best_model <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>best_logdir<span class="token punctuation">,</span> <span class="token string">&quot;training&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;model.tar.gz&quot;</span><span class="token punctuation">)</span>
pl_trained <span class="token operator">=</span> Pipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>best_model<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>pl_trained<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token string">&quot;Autohaus Recognai&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>Or we can use <em>biome.text</em>'s explore UI to evaluate the performance of our model in more detail.</p> <div class="custom-block warning"><p class="custom-block-title">Warning</p> <p>For the UI to work you need a running <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html" target="_blank" rel="noopener noreferrer">Elasticsearch<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> instance.
We recommend installing <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.7/docker.html#docker-cli-run-dev-mode" target="_blank" rel="noopener noreferrer">Elasticsearch with docker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> biome<span class="token punctuation">.</span>text <span class="token keyword">import</span> explore

explore<span class="token punctuation">.</span>create<span class="token punctuation">(</span>pl_trained<span class="token punctuation">,</span> valid_ds<span class="token punctuation">,</span> explain<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/biome-text/assets/img/text_classifier_explore_screenshot.b068fd60.png" alt="Screenshot of the biome.text explore UI"> <em>Screenshot of the biome.text explore UI</em></p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>For an unbiased evaluation of the model you should use a test dataset that was not used during the HPO!</p></div> <h2 id="appendix-custom-hpo-with-ray-tune"><a href="#appendix-custom-hpo-with-ray-tune" class="header-anchor">#</a> Appendix: Custom HPO with ray tune</h2> <p>As seen in this tutorial, <em>biome.text</em> provides you some convenient tools to easily perform HPO in a few steps.
To take advantage of all the ray tune features, you can also define your own trainable function and follow ray tune's <a href="https://docs.ray.io/en/latest/tune/api_docs/trainable.html#tune-function-api" target="_blank" rel="noopener noreferrer">function API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Below we give a minimal example of such an approach.</p> <h3 id="implementing-the-report"><a href="#implementing-the-report" class="header-anchor">#</a> Implementing the report</h3> <p>A lot of features in ray tune require the trials to report some metrics during their trainings, such as trial schedulers that adaptively allocate resources as the ASHA scheduler used above.
For the reporting we can use the abstract <code>biome.text.loggers.BaseTrainLogger</code> class, that allows to make callbacks after each epoch:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">TuneReporter</span><span class="token punctuation">(</span>BaseTrainLogger<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">log_epoch_metrics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> metrics<span class="token punctuation">)</span><span class="token punctuation">:</span>
        tune<span class="token punctuation">.</span>report<span class="token punctuation">(</span>
            validation_loss<span class="token operator">=</span>metrics<span class="token punctuation">[</span><span class="token string">&quot;validation_loss&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
            validation_accuracy<span class="token operator">=</span>metrics<span class="token punctuation">[</span><span class="token string">&quot;validation_accuracy&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
        
tune_reporter <span class="token operator">=</span> TuneReport<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="defining-the-training-loop"><a href="#defining-the-training-loop" class="header-anchor">#</a> Defining the training loop</h3> <p>Following the <a href="https://docs.ray.io/en/latest/tune/api_docs/trainable.html#tune-function-api" target="_blank" rel="noopener noreferrer">function-based Trainable API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, we now have to define a <code>trainable</code> function that takes as input a configuration dictionary and executes a training run:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">trainable</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pl <span class="token operator">=</span> Pipeline<span class="token punctuation">.</span>from_config<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">&quot;pipeline&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    trainer_config <span class="token operator">=</span> TrainerConfiguration<span class="token punctuation">(</span><span class="token operator">**</span>config<span class="token punctuation">[</span><span class="token string">&quot;trainer&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    train_ds <span class="token operator">=</span> DataSource<span class="token punctuation">(</span>train_path<span class="token punctuation">)</span>
    valid_ds <span class="token operator">=</span> DataSource<span class="token punctuation">(</span>valid_path<span class="token punctuation">)</span>
    
    pl<span class="token punctuation">.</span>create_vocabulary<span class="token punctuation">(</span>VocabularyConfiguration<span class="token punctuation">(</span>sources<span class="token operator">=</span><span class="token punctuation">[</span>train_ds<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    pl<span class="token punctuation">.</span>train<span class="token punctuation">(</span>
        output<span class="token operator">=</span><span class="token string">&quot;output&quot;</span><span class="token punctuation">,</span>
        training<span class="token operator">=</span>train_ds<span class="token punctuation">,</span>
        validation<span class="token operator">=</span>valid_ds<span class="token punctuation">,</span>
        trainer<span class="token operator">=</span>trainer_config<span class="token punctuation">,</span>
        loggers<span class="token operator">=</span><span class="token punctuation">[</span>tune_report<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre></div><p>In the <code>Pipeline.train()</code> method above we added our <code>tune_reporter</code> instance to the loggers in order to report the validation loss and accuracy back to tune.
Note that we did not include a MLFlow or WandB logger!</p> <p>The <code>config</code> dictionary, where we define the pipeline, trainer and the hyperparameters, could look something like this:</p> <div class="language-python extra-class"><pre class="language-python"><code>configs <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;pipeline&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;german_business_names&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;tokenizer&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;text_cleaning&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;rules&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;strip_spaces&quot;</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;features&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;word&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;embedding_dim&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;lowercase_tokens&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;head&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;TextClassification&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;labels&quot;</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>labels<span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;pooler&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;gru&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lstm&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;num_layers&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;hidden_size&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;bidirectional&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>       
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token string">&quot;trainer&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;optimizer&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;adam&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;lr&quot;</span><span class="token punctuation">:</span> tune<span class="token punctuation">.</span>loguniform<span class="token punctuation">(</span><span class="token number">0.001</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;num_epochs&quot;</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>With the trainable function at hand we can now call the <code>tune.run</code> method to start our HPO.</p> <div class="language-python extra-class"><pre class="language-python"><code>analysis <span class="token operator">=</span> tune<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
    trainable<span class="token punctuation">,</span> 
    config<span class="token operator">=</span>configs<span class="token punctuation">,</span> 
    num_samples<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> 
<span class="token punctuation">)</span>
</code></pre></div><p>For an advanced example with checkpointing, you can have a look at the colab notebook <a href="https://colab.research.google.com/drive/1vmt3D_2kq6VxE2-nlwsZl0YrN3nAhHp0?usp=sharing" target="_blank" rel="noopener noreferrer"><em>Population Based Training with biome.text</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="page-nav__button prev"><a href="/biome-text/documentation/tutorials/2-Training_a_sequence_tagger_for_Slot_Filling.html" class="prev"><span class="page-nav__button__icon"><vp-icon color="#4A4A4A" name="chev-left" size="18px"></vp-icon></span> <span class="page-nav__button__text">
          Training a sequence tagger for Slot Filling
        </span></a></span> <span class="page-nav__button next"><a href="/biome-text/documentation/user-guides/1-nlp-tasks.html"><span class="page-nav__button__text">
          NLP Tasks
        </span> <span class="page-nav__button__icon"><vp-icon color="#4A4A4A" name="chev-right" size="18px"></vp-icon></span></a></span></p></div> <footer class="footer" data-v-44f1b6a5><div data-v-44f1b6a5>
          Maintained by
          <a href="https://www.recogn.ai/" target="_blank" data-v-44f1b6a5><img width="70px" src="/biome-text/assets/img/recognai.png" class="footer__img" data-v-44f1b6a5></a></div></footer> </main></div><div class="global-ui"><!----></div></div>
    <script src="/biome-text/assets/js/app.6e62ef31.js" defer></script><script src="/biome-text/assets/js/4.2d46529d.js" defer></script><script src="/biome-text/assets/js/3.73bd0a1f.js" defer></script><script src="/biome-text/assets/js/5.5615e4e8.js" defer></script>
  </body>
</html>
